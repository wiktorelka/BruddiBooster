<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BruddiBooster</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-body: #0b0e14; --bg-card: #151a21; --bg-input: #0b0e14; --accent: #3b99fc; --accent-hover: #2b82e0; --text-main: #ffffff; --text-muted: #6e7681; --border: #232830; --btn-red: #d94545; --status-green: #4ade80; --status-yellow: #facc15; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; color: var(--text-main); font-size: 14px; font-weight: 500; }
        .toast i { color: var(--accent); font-size: 16px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 16px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .login-logo { color: var(--accent); font-size: 24px; font-weight: 800; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .login-logo i { font-size: 40px; }
        .login-input-group { position: relative; margin-bottom: 15px; width: 100%; display: flex; align-items: center; }
        .login-input-group i { position: absolute; left: 20px; color: var(--accent); font-size: 16px; pointer-events: none; }
        .login-input { width: 100%; padding: 14px 15px 14px 50px; background: var(--bg-input); border: 1px solid #2a303b; border-radius: 50px; color: white; font-size: 15px; outline: none; transition: 0.2s; text-align: left; }
        .login-input:focus { border-color: var(--accent); }
        #panel2FA { text-align: center; padding-left: 15px; letter-spacing: 5px; font-size: 18px; padding-top: 12px; padding-bottom: 12px; }
        .remember-me-container { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 20px; padding-left: 10px; color: var(--text-muted); font-size: 14px; }
        .remember-me-container input[type="checkbox"] { margin-right: 8px; accent-color: var(--accent); cursor: pointer; transform: scale(1.1); }
        .remember-me-container label { cursor: pointer; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .login-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 18px; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
        .brand i { color: var(--accent); font-size: 22px; }
        .menu { flex: 1; padding: 20px 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: #949ba4; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item:hover { background: #1e232b; color: white; }
        .nav-item.active { background: rgba(59, 153, 252, 0.1); color: var(--accent); }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); }
        .btn-logout { width: 100%; padding: 10px; background: #1e232b; color: var(--btn-red); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-logout:hover { background: var(--btn-red); color: white; border-color: var(--btn-red); }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg-body); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-controls { display: flex; gap: 10px; }
        .primary-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .primary-btn:hover { background: var(--accent-hover); }
        .dash-stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .dash-card { flex: 1; background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px; }
        .dash-icon { width: 50px; height: 50px; border-radius: 10px; background: rgba(59, 153, 252, 0.1); color: var(--accent); display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .dash-info { display: flex; flex-direction: column; }
        .dash-label { color: var(--text-muted); font-size: 12px; font-weight: 500; }
        .dash-value { color: white; font-size: 22px; font-weight: 700; margin-top: 2px; }
        .panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 25px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 15px 25px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 14px; }
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 42px; height: 42px; border-radius: 8px; background: #232830; object-fit: cover; border: 1px solid var(--border); }
        .user-details { display: flex; flex-direction: column; }
        .user-nick { font-weight: 600; color: white; font-size: 14px; }
        .user-name { color: var(--text-muted); font-size: 11px; margin-top: 2px; }
        .category-badge { display: inline-block; background: #2a303b; color: #a0a0a0; font-size: 10px; padding: 1px 6px; border-radius: 3px; margin-left: 6px; vertical-align: middle; }
        .autostart-icon { color: var(--status-yellow); font-size: 12px; margin-left: 6px; }
        .st-running { color: var(--status-green); font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .st-stopped { color: var(--btn-red); font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .st-guard { color: var(--status-yellow); font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .st-logging { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .actions { display: flex; gap: 8px; }
        .icon-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; text-decoration: none; }
        .icon-btn:hover { border-color: var(--text-muted); color: white; }
        .btn-play { border-color: var(--status-green); color: var(--status-green); }
        .btn-play:hover { background: rgba(74, 222, 128, 0.1); color: #86efac; border-color: #86efac; }
        .btn-stop-action { border-color: var(--btn-red); color: var(--btn-red); }
        .btn-stop-action:hover { background: rgba(217, 69, 69, 0.1); color: #f87171; border-color: #f87171; }
        .btn-trash:hover { border-color: var(--btn-red); color: var(--btn-red); background: rgba(217, 69, 69, 0.1); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: var(--bg-card); padding: 30px; border-radius: 12px; width: 450px; border: 1px solid var(--border); }
        .modal h3 { margin-top: 0; margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 5px; }
        .form-input, .form-select, textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; outline: none; font-family: 'Inter', sans-serif; }
        .form-input:focus, .form-select:focus, textarea:focus { border-color: var(--accent); }
        textarea { resize: vertical; min-height: 100px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-sec:hover { color: white; border-color: white; }
        .game-tags { display: flex; flex-wrap: wrap; gap: 8px; background: var(--bg-input); padding: 10px; border-radius: 8px; border: 1px solid var(--border); min-height: 50px; margin-bottom: 10px; }
        .tag { background: #232830; padding: 4px 10px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 6px; border: 1px solid #2f3640; }
        .tag-id { color: var(--text-muted); font-size: 10px; }
        .tag-x { color: var(--btn-red); cursor: pointer; font-weight: bold; }
        .search-results { background: #232830; border: 1px solid var(--border); max-height: 200px; overflow-y: auto; display: none; position: absolute; width: 100%; z-index: 100; border-radius: 6px; margin-top: 5px; }
        .search-item { padding: 8px 12px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; }
        .search-item:hover { background: var(--accent); color: white; }
        .log-container { background: #000; padding: 15px; border-radius: 8px; height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #a0a0a0; }
        .log-line { border-bottom: 1px solid #111; padding: 4px 0; }
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .settings-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 25px; }
        .settings-card h3 { margin-top: 0; margin-bottom: 15px; font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .settings-card h3 i { color: var(--accent); }
        .status-active-2fa { color: var(--status-green); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: rgba(74, 222, 128, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.3); }
        .status-inactive-2fa { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px; }
        .stat-label { color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { color: white; font-size: 18px; font-weight: bold; margin-top: 5px; }
        .check-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .check-row input { width: auto; margin: 0; cursor: pointer; }
        .check-row label { margin: 0; cursor: pointer; color: var(--text-main); }
        .library-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .library-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #fff; }
        .library-list { max-height: 150px; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .library-item { background: #232830; padding: 8px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .library-item:hover { border-color: var(--accent); color: white; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="loginOverlay">
        <div class="login-card">
            <div class="login-logo"><i class="fa-brands fa-steam"></i> BruddiBooster</div>
            <div id="loginStep1"><div class="login-input-group"><i class="fa-solid fa-user"></i><input type="text" id="panelUser" class="login-input" placeholder="Username" autocomplete="off"></div><div class="login-input-group"><i class="fa-solid fa-lock"></i><input type="password" id="panelPass" class="login-input" placeholder="Password"></div><div class="remember-me-container"><input type="checkbox" id="rememberMe"><label for="rememberMe">Remember me</label></div><button class="login-btn" onclick="performLogin()">Login</button></div>
            <div id="loginStep2" class="hidden"><p style="color: var(--text-muted); margin-bottom: 15px; font-size: 14px;">Enter 2FA Code</p><div class="login-input-group"><i class="fa-solid fa-shield-halved"></i><input type="text" id="panel2FA" class="login-input" placeholder="000000" maxlength="6" autocomplete="one-time-code"></div><button class="login-btn" onclick="performLogin(true)">Verify Code</button></div>
            <p id="loginError" style="color: var(--btn-red); font-size: 12px; margin-top: 15px; display: none;">Invalid credentials</p>
        </div>
    </div>
    <div class="sidebar">
        <div class="brand"><i class="fa-brands fa-steam"></i> BruddiBooster</div>
        <div class="menu"><div class="nav-item active" id="nav-dash" onclick="switchTab('dash')"><i class="fa-solid fa-server"></i> Dashboard</div><div class="nav-item" id="nav-logs" onclick="switchTab('logs')"><i class="fa-solid fa-terminal"></i> Logs</div><div class="nav-item" id="nav-users" onclick="switchTab('users')" style="display: none;"><i class="fa-solid fa-users"></i> Users</div><div class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="fa-solid fa-gear"></i> Settings</div></div>
        <div class="sidebar-footer"><button class="btn-logout" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button></div>
    </div>
    <div class="main-content">
        <div id="view-dash">
            <div class="dash-stats-row"><div class="dash-card"><div class="dash-icon"><i class="fa-solid fa-users"></i></div><div class="dash-info"><span class="dash-label">Total Accounts</span><span class="dash-value" id="totalAccounts">0</span></div></div><div class="dash-card"><div class="dash-icon" style="color:var(--status-green); background:rgba(74,222,128,0.1);"><i class="fa-solid fa-play"></i></div><div class="dash-info"><span class="dash-label">Active Boosters</span><span class="dash-value" id="activeBoosters" style="color:var(--status-green)">0</span></div></div><div class="dash-card"><div class="dash-icon" style="color:#facc15; background:rgba(250,204,21,0.1);"><i class="fa-solid fa-clock"></i></div><div class="dash-info"><span class="dash-label">Total Hours Farmed</span><span class="dash-value" id="totalHours">0.0h</span></div></div></div>
            <div class="header"><h1>Accounts</h1><div class="header-controls"><select id="categoryFilter" class="form-select" style="width: 150px;" onchange="fetchAccounts()"><option value="All">All Categories</option></select><button class="primary-btn" onclick="openBulkModal()"><i class="fa-solid fa-list-ul"></i> Bulk Add</button><button class="primary-btn" onclick="openAddModal()"><i class="fa-solid fa-plus"></i> Add Account</button></div></div>
            <div class="panel"><table><thead><tr><th>User</th><th>Status</th><th>Hours</th><th>Actions</th></tr></thead><tbody id="accountTableBody"></tbody></table></div>
        </div>
        <div id="view-users" style="display: none;"><div class="header"><h1>Users</h1><button class="primary-btn" onclick="document.getElementById('addUserModal').style.display='flex'"><i class="fa-solid fa-user-plus"></i> Add User</button></div><div class="panel"><table><thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead><tbody id="usersTableBody"></tbody></table></div></div>
        <div id="view-logs" style="display: none;"><div class="header"><h1>System Logs</h1><button class="primary-btn" onclick="fetchLogs()"><i class="fa-solid fa-sync-alt"></i> Refresh</button></div><div class="log-container" id="logsContainer"></div></div>
        <div id="view-settings" style="display: none;"><div class="header"><h1>Settings</h1></div><div class="settings-grid"><div class="settings-card"><h3><i class="fa-solid fa-lock"></i> Security</h3><div class="form-group"><label>Current Password</label><input type="password" class="form-input" id="setOldPass"></div><div class="form-group"><label>New Password</label><input type="password" class="form-input" id="setNewPass"></div><button class="primary-btn" onclick="changePassword()" style="margin-top:10px;">Update Password</button></div><div class="settings-card"><h3><i class="fa-solid fa-shield-halved"></i> Two-Factor Authentication</h3><div id="2fa-content-area"></div></div></div></div>
    </div>
    <div id="addModal" class="modal-overlay"><div class="modal"><h3>Add Account</h3><div class="form-group"><label>Username</label><input type="text" class="form-input" id="newUsername" autocomplete="off"></div><div class="form-group"><label>Password</label><input type="password" class="form-input" id="newPassword" autocomplete="new-password"></div><div class="form-group"><label>Shared Secret (Optional)</label><input type="password" class="form-input" id="newSharedSecret"></div><div class="form-group"><label>Category</label><input type="text" class="form-input" id="newCategory" placeholder="Default"></div><div class="check-row"><input type="checkbox" id="newAutoStart"><label for="newAutoStart">Auto-start on Server Boot</label></div><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="addAccount()">Add</button></div></div></div>
    <div id="bulkModal" class="modal-overlay"><div class="modal"><h3>Bulk Import</h3><p style="color:var(--text-muted);font-size:12px;margin-bottom:10px;">Format: <code>username:password</code> or <code>username:password:secret</code> (one per line)</p><textarea id="bulkData" placeholder="user1:pass1&#10;user2:pass2:secret"></textarea><div class="form-group" style="margin-top:15px;"><label>Assign Category</label><input type="text" class="form-input" id="bulkCategory" placeholder="Default"></div><div class="check-row"><input type="checkbox" id="bulkAutoStart"><label for="bulkAutoStart">Auto-start imported accounts</label></div><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="bulkAddAccounts()">Import</button></div></div></div>
    <div id="editModal" class="modal-overlay"><div class="modal"><h3>Edit Account</h3><input type="hidden" id="editOldUsername"><div class="form-group"><label>Username</label><input type="text" class="form-input" id="editUsername"></div><div class="form-group"><label>Password</label><input type="password" class="form-input" id="editPassword"></div><div class="form-group"><label>Shared Secret</label><input type="password" class="form-input" id="editSharedSecret"></div><div class="form-group"><label>Category</label><input type="text" class="form-input" id="editCategory"></div><div class="check-row"><input type="checkbox" id="editAutoStart"><label for="editAutoStart">Auto-start on Server Boot</label></div><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="saveEdit()">Save</button></div></div></div>
    <div id="gamesModal" class="modal-overlay"><div class="modal" style="width: 500px;"><h3>Manage Games</h3><div class="game-tags" id="selectedGamesBox"></div><div style="position:relative;margin-bottom:15px;"><input type="text" class="form-input" id="gameSearch" placeholder="Search games..."><div class="search-results" id="searchResults"></div></div><div style="display:flex;gap:10px;"><div class="form-group" style="flex:1;"><label>Online Status</label><select id="personaState" class="form-select"><option value="1">Online</option><option value="0">Offline</option><option value="3">Away</option><option value="4">Snooze</option><option value="5">Trading</option><option value="6">Playing</option></select></div><div class="form-group" style="flex:2;"><label>Custom Status Text</label><input type="text" class="form-input" id="customStatus"></div></div><div class="library-section"><div class="library-title">My Library (Click to add)</div><div class="library-list" id="myLibraryList"><p style="color:#666;font-size:12px;text-align:center;">Loading owned games...</p></div></div><input type="hidden" id="manageGameUsername"><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="saveGames()">Save</button></div></div></div>
    <div id="guardModal" class="modal-overlay"><div class="modal"><h3>Steam Guard</h3><input type="hidden" id="guardUsername"><div class="form-group"><label>Code</label><input type="text" class="form-input" id="guardCode" style="text-align:center;font-size:20px;letter-spacing:5px;"></div><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="submitGuard()">Submit</button></div></div></div>
    <div id="addUserModal" class="modal-overlay"><div class="modal"><h3>Add User</h3><div class="form-group"><label>Username</label><input type="text" class="form-input" id="friendUser"></div><div class="form-group"><label>Password</label><input type="text" class="form-input" id="friendPass"></div><div class="modal-footer"><button class="btn-sec" onclick="closeModals()">Cancel</button><button class="primary-btn" onclick="addPanelUser()">Create</button></div></div></div>
    <div id="modal2FA" class="modal-overlay"><div class="modal" style="text-align:center;"><h3>Setup 2FA</h3><div id="qrCodeContainer" style="background:#fff;padding:10px;display:inline-block;border-radius:8px;"></div><p style="font-size:12px;color:#666;margin:15px 0;">Scan with Authenticator App</p><input type="text" id="verify2faInput" class="form-input" placeholder="Enter Code" style="text-align:center;"><button class="primary-btn" onclick="enable2FA()" style="width:100%;margin-top:10px;">Enable</button><button class="btn-sec" onclick="document.getElementById('modal2FA').style.display='none'" style="width:100%;margin-top:10px;">Cancel</button></div></div>
    <div id="statsModal" class="modal-overlay"><div class="modal"><h3>Boost Statistics</h3><div class="stat-box"><div class="stat-label">Added To Library</div><div class="stat-value"><span id="statAdded"></span></div></div><div class="stat-box"><div class="stat-label">Total Boosted Time</div><div class="stat-value" style="color:var(--status-green);"><span id="statBoosted"></span> Hours</div></div><p style="font-size:12px;color:#666;margin-top:10px;">*Calculation: 1 real hour x N games running.</p><div class="modal-footer"><button class="primary-btn" onclick="document.getElementById('statsModal').style.display='none'">Close</button></div></div></div>

    <script>
        let authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        let currentUserRole = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');
        let userHas2FA = false; 
        let currentSelectedGames = []; let ownedGames = [];
        let tempSecret = ''; let activeTab = 'dash';

        (async function init() {
            if (authToken) {
                const res = await fetch('/api/verify_session', { headers: { 'Authorization': authToken } });
                const d = await res.json();
                if (d.success) { document.getElementById('loginOverlay').style.display = 'none'; currentUserRole = d.role; userHas2FA = d.has2FA; setupUI(); fetchAccounts(); }
                else { localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken'); document.getElementById('loginOverlay').style.display = 'flex'; }
            } else {
                const savedUser = localStorage.getItem('rememberedUser');
                if (savedUser) { document.getElementById('panelUser').value = savedUser; document.getElementById('rememberMe').checked = true; }
            }
        })();

        function showToast(msg, icon='fa-circle-info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className='toast'; t.innerHTML=`<i class="fa-solid ${icon}"></i><span>${msg}</span>`; c.appendChild(t); setTimeout(()=>{ t.style.animation='slideOut 0.3s ease-in forwards'; setTimeout(()=>t.remove(),300); },3000); }
        async function apiCall(endpoint, method='GET', body=null) {
            const headers = { 'Content-Type': 'application/json' }; if(authToken) headers['Authorization'] = authToken;
            const res = await fetch(endpoint, { method, headers, body: body ? JSON.stringify(body) : null });
            if (res.status === 401) { document.getElementById('loginOverlay').style.display='flex'; localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken'); return null; }
            return res.json();
        }

        async function performLogin(is2FA = false) {
            const u = document.getElementById('panelUser').value; const p = document.getElementById('panelPass').value; const t = document.getElementById('panel2FA').value; const remember = document.getElementById('rememberMe').checked;
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username:u, password:p, token: is2FA ? t : null }) });
            const d = await res.json();
            if (d.requires2fa) { document.getElementById('loginStep1').classList.add('hidden'); document.getElementById('loginStep2').classList.remove('hidden'); document.getElementById('loginError').style.display='none'; document.getElementById('panel2FA').value = ''; }
            else if (d.success) {
                authToken = d.token; currentUserRole = d.role; userHas2FA = d.has2FA;
                if(remember) { localStorage.setItem('authToken', authToken); localStorage.setItem('userRole', d.role); localStorage.setItem('rememberedUser', u); }
                else { sessionStorage.setItem('authToken', authToken); sessionStorage.setItem('userRole', d.role); localStorage.removeItem('rememberedUser'); }
                document.getElementById('loginOverlay').style.display='none'; showToast(`Welcome back, ${u}!`, 'fa-door-open'); setupUI(); fetchAccounts();
            } else { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').innerText=d.msg||"Invalid credentials"; }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${tab}`).classList.add('active');
            ['dash','users','logs','settings'].forEach(v => document.getElementById(`view-${v}`).style.display='none');
            document.getElementById(`view-${tab}`).style.display='block';
            if(tab==='dash') fetchAccounts(); if(tab==='users') fetchUsers(); if(tab==='logs') fetchLogs(); if(tab==='settings') renderSettings();
        }
        function setupUI() { document.getElementById('nav-users').style.display = currentUserRole === 'admin' ? 'flex' : 'none'; }
        async function logout() { await apiCall('/api/logout', 'POST'); localStorage.removeItem('authToken'); localStorage.removeItem('userRole'); sessionStorage.removeItem('authToken'); sessionStorage.removeItem('userRole'); location.reload(); }
        async function handleAction(action, username) { showToast(`${action} ${username}...`, 'fa-gear'); await apiCall(`/api/${action}`, 'POST', { username }); fetchAccounts(); }

        // RENDER SETTINGS based on 2FA status
        function renderSettings() {
            const area = document.getElementById('2fa-content-area');
            if (userHas2FA) {
                area.innerHTML = `
                    <div class="status-active-2fa"><i class="fa-solid fa-check-circle"></i> 2FA is Active. Account Secured.</div>
                    <button class="primary-btn btn-stop-action" onclick="disable2FA()"><i class="fa-solid fa-ban"></i> Disable 2FA</button>
                `;
            } else {
                area.innerHTML = `
                    <p class="status-inactive-2fa">Protect your admin panel with Google Authenticator.</p>
                    <button class="primary-btn" onclick="start2FASetup()"><i class="fa-solid fa-shield-halved"></i> Setup 2FA</button>
                `;
            }
        }

        async function disable2FA() {
            if(confirm("Disable 2FA?")) {
                const res = await apiCall('/api/settings/2fa/disable', 'POST');
                if(res && res.success) { userHas2FA = false; renderSettings(); showToast('2FA Disabled', 'fa-shield-halved'); }
            }
        }

        function renderTable(accounts) {
            const filter = document.getElementById('categoryFilter').value;
            const filtered = filter === 'All' ? accounts : accounts.filter(a => a.category === filter);
            const dropdown = document.getElementById('categoryFilter');
            const currentOpts = Array.from(dropdown.options).map(o => o.value);
            [...new Set(accounts.map(a => a.category || 'Default'))].forEach(c => { if(!currentOpts.includes(c)) { const o = document.createElement('option'); o.value=c; o.innerText=c; dropdown.appendChild(o); } });

            document.getElementById('totalAccounts').innerText = accounts.length;
            document.getElementById('activeBoosters').innerText = accounts.filter(a => a.status==='Running').length;
            document.getElementById('totalHours').innerText = accounts.reduce((a,c) => a + parseFloat(c.grandTotal||0), 0).toFixed(1) + 'h';

            const tbody = document.getElementById('accountTableBody'); tbody.innerHTML = '';
            filtered.forEach(acc => {
                const isRunning = acc.status === 'Running';
                let stHtml = `<span class="st-stopped">${acc.status}</span>`;
                if(isRunning) stHtml = `<span class="st-running">Running</span>`;
                if(acc.status==='Need Guard') stHtml = `<span class="st-guard">Guard</span>`;
                if(acc.status==='Logging in...') stHtml = `<span class="st-logging">Logging in...</span>`;
                
                // ADD TOOLTIP TO ERROR STATUS
                if (acc.status === 'Error' && acc.lastError) {
                    stHtml = `<span class="st-stopped" style="cursor:help; border-bottom:1px dotted var(--btn-red);" title="${acc.lastError}">ERROR</span>`;
                }

                const avatarUrl = acc.avatarHash ? `https://avatars.steamstatic.com/${acc.avatarHash}_full.jpg` : 'https://avatars.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg';
                const categoryBadge = acc.category && acc.category !== 'Default' ? `<span class="category-badge">${acc.category}</span>` : '';
                const autoStartIcon = acc.autoStart ? `<i class="fa-solid fa-bolt autostart-icon" title="Auto-start Enabled"></i>` : '';
                const gamesJson = JSON.stringify(acc.games).replace(/"/g, '&quot;');
                const profileBtn = acc.steamId ? `<a href="https://steamcommunity.com/profiles/${acc.steamId}" target="_blank" class="icon-btn"><i class="fa-solid fa-up-right-from-square"></i></a>` : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `<td><div class="user-cell"><img src="${avatarUrl}" class="user-avatar" alt="Avatar"><div class="user-details"><div><span class="user-nick">${acc.nickname||acc.username}</span>${categoryBadge}${autoStartIcon}</div><span class="user-name">${acc.username}</span></div></div></td><td>${stHtml}</td><td style="color:white;font-weight:600;">${acc.grandTotal}h</td><td><div class="actions">${isRunning?`<button class="icon-btn btn-stop-action" onclick="handleAction('stop','${acc.username}')"><i class="fa-solid fa-stop"></i></button><button class="icon-btn" onclick="handleAction('restart','${acc.username}')"><i class="fa-solid fa-rotate-right"></i></button>`:`<button class="icon-btn btn-play" onclick="handleAction('start','${acc.username}')"><i class="fa-solid fa-play"></i></button>`}<button class="icon-btn" style="width:auto;padding:0 12px;gap:6px;" onclick="openGamesModal('${acc.username}', ${gamesJson}, '${acc.customStatus||''}', ${acc.personaState})"><i class="fa-solid fa-gamepad"></i> <span style="font-size:11px;font-weight:600;">${acc.games.length}/32</span></button><button class="icon-btn" onclick="openStats('${acc.addedAt}', ${acc.boostedHours})"><i class="fa-solid fa-chart-line"></i></button>${profileBtn}<button class="icon-btn" onclick="openEditModal('${acc.username}', '${acc.category||''}', ${acc.autoStart})"><i class="fa-solid fa-pen"></i></button><button class="icon-btn btn-trash" onclick="deleteAccount('${acc.username}')"><i class="fa-solid fa-trash"></i></button>${acc.status==='Need Guard'?`<button class="icon-btn" style="color:var(--status-yellow);border-color:var(--status-yellow);" onclick="openGuard('${acc.username}')"><i class="fa-solid fa-key"></i></button>`:''}</div></td>`;
                tbody.appendChild(tr);
            });
        }

        async function fetchAccounts() { const d = await apiCall('/api/accounts'); if(d) renderTable(d); }
        async function fetchLogs() { const l = await apiCall('/api/logs'); document.getElementById('logsContainer').innerHTML = l.map(m=>`<div class="log-line">${m}</div>`).join(''); }
        async function fetchUsers() { const u = await apiCall('/api/users'); document.getElementById('usersTableBody').innerHTML = u.map(x=>`<tr><td style="color:white;">${x.username}</td><td style="color:#888;">${x.role}</td><td>${x.role!=='admin'?`<button class="icon-btn btn-trash" onclick="delUser('${x.username}')"><i class="fa-solid fa-trash"></i></button>`:''}</td></tr>`).join(''); }

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function openAddModal() { document.getElementById('newUsername').value=''; document.getElementById('newPassword').value=''; document.getElementById('newCategory').value=''; document.getElementById('newAutoStart').checked=false; document.getElementById('addModal').style.display='flex'; }
        function openBulkModal() { document.getElementById('bulkData').value=''; document.getElementById('bulkCategory').value=''; document.getElementById('bulkAutoStart').checked=false; document.getElementById('bulkModal').style.display='flex'; }
        function openUserModal() { document.getElementById('friendUser').value=''; document.getElementById('friendPass').value=''; document.getElementById('addUserModal').style.display='flex'; }
        function openGuard(u) { document.getElementById('guardUsername').value = u; document.getElementById('guardModal').style.display = 'flex'; }
        function openStats(date, hours) { document.getElementById('statAdded').innerText = new Date(parseInt(date)).toLocaleDateString(); document.getElementById('statBoosted').innerText = parseFloat(hours).toFixed(1); document.getElementById('statsModal').style.display = 'flex'; }

        async function openEditModal(u, cat, auto) { const d = await apiCall('/api/get_account', 'POST', { username: u }); document.getElementById('editOldUsername').value = d.username; document.getElementById('editUsername').value = d.username; document.getElementById('editPassword').value = d.password; document.getElementById('editSharedSecret').value = d.sharedSecret; document.getElementById('editCategory').value = d.category || cat; document.getElementById('editAutoStart').checked = d.autoStart; document.getElementById('editModal').style.display = 'flex'; }
        async function addAccount() { await apiCall('/api/accounts', 'POST', { username: document.getElementById('newUsername').value, password: document.getElementById('newPassword').value, sharedSecret: document.getElementById('newSharedSecret').value, category: document.getElementById('newCategory').value, autoStart: document.getElementById('newAutoStart').checked }); closeModals(); fetchAccounts(); }
        async function bulkAddAccounts() { const data = document.getElementById('bulkData').value; const cat = document.getElementById('bulkCategory').value; const auto = document.getElementById('bulkAutoStart').checked; const res = await apiCall('/api/accounts/bulk', 'POST', { data, category: cat, autoStart: auto }); if(res && res.success) { showToast(`Imported ${res.count} accounts`, 'fa-check'); closeModals(); fetchAccounts(); } }
        async function saveEdit() { await apiCall('/api/edit', 'POST', { oldUsername: document.getElementById('editOldUsername').value, newUsername: document.getElementById('editUsername').value, newPassword: document.getElementById('editPassword').value, newSharedSecret: document.getElementById('editSharedSecret').value, newCategory: document.getElementById('editCategory').value, newAutoStart: document.getElementById('editAutoStart').checked }); closeModals(); fetchAccounts(); }
        async function deleteAccount(u) { if(confirm('Delete Account?')) await apiCall('/api/delete', 'POST', { username: u }); fetchAccounts(); }
        async function submitGuard() { await apiCall('/api/steamguard', 'POST', { username: document.getElementById('guardUsername').value, code: document.getElementById('guardCode').value }); closeModals(); fetchAccounts(); }
        async function addPanelUser() { await apiCall('/api/users', 'POST', { username: document.getElementById('friendUser').value, password: document.getElementById('friendPass').value }); closeModals(); fetchUsers(); }
        async function delUser(u) { if(confirm('Delete User?')) await apiCall('/api/users/delete', 'POST', { username: u }); fetchUsers(); }

        async function changePassword() { const d = await apiCall('/api/settings/password', 'POST', { currentPass: document.getElementById('setOldPass').value, newPass: document.getElementById('setNewPass').value }); alert(d&&d.success?"Updated":"Error"); }
        async function start2FASetup() { const d = await apiCall('/api/settings/2fa/generate', 'POST'); tempSecret = d.secret; document.getElementById('qrCodeContainer').innerHTML = `<img src="${d.qr}" width="150">`; document.getElementById('modal2FA').style.display = 'flex'; }
        async function enable2FA() { const d = await apiCall('/api/settings/2fa/enable', 'POST', { token: document.getElementById('verify2faInput').value, secret: tempSecret }); if(d&&d.success) { userHas2FA = true; renderSettings(); document.getElementById('modal2FA').style.display = 'none'; showToast('2FA Enabled', 'fa-check'); } else alert("Invalid Code"); }

        // --- NEW: FETCH LIBRARY ---
        async function fetchLibrary(u) {
            const list = document.getElementById('myLibraryList');
            list.innerHTML = '<p style="color:#666;font-size:12px;text-align:center;">Loading owned games...</p>';
            const res = await apiCall('/api/library', 'POST', { username: u });
            list.innerHTML = '';
            ownedGames = res.games || [];
            
            if(ownedGames.length === 0) {
                list.innerHTML = '<p style="color:#666;font-size:12px;text-align:center;">No games found (Start bot first)</p>';
                return;
            }
            
            ownedGames.forEach(g => {
                const item = document.createElement('div');
                item.className = 'library-item';
                item.innerText = g.name;
                item.onclick = () => addGame(g.id, g.name);
                list.appendChild(item);
            });
        }

        function openGamesModal(u, g, c, s) { 
            document.getElementById('manageGameUsername').value = u; 
            currentSelectedGames = g; 
            document.getElementById('customStatus').value = c; 
            document.getElementById('personaState').value = s || 1; 
            renderTags(); 
            document.getElementById('gamesModal').style.display='flex'; 
            document.getElementById('gameSearch').value=''; 
            document.getElementById('searchResults').style.display='none'; 
            
            // FETCH LIBRARY ON OPEN
            fetchLibrary(u);
        }
        
        function renderTags() { const b = document.getElementById('selectedGamesBox'); b.innerHTML = ''; currentSelectedGames.forEach(g => b.innerHTML += `<div class="tag"><span>${g.name}</span><span class="tag-id">${g.id}</span><span class="tag-x" onclick="removeGame(${g.id})">&times;</span></div>`); }
        function removeGame(id) { currentSelectedGames = currentSelectedGames.filter(g=>g.id!==id); renderTags(); }
        function addGame(id, name) { if(currentSelectedGames.length>=32) return alert('Max 32'); if(!currentSelectedGames.find(g=>g.id===id)) currentSelectedGames.push({id,name}); renderTags(); document.getElementById('gameSearch').value=''; document.getElementById('searchResults').style.display='none'; }
        
        const si = document.getElementById('gameSearch'); let st;
        // UPDATED SEARCH LOGIC: Filter GLOBAL games AND LOCAL library
        si.addEventListener('input', () => { 
            clearTimeout(st); 
            const q = si.value.trim().toLowerCase(); 
            if(q.length<2) { document.getElementById('searchResults').style.display='none'; return; } 
            
            st = setTimeout(async()=>{ 
                // 1. Search Global DB
                const res = await apiCall(`/api/search_games?q=${encodeURIComponent(q)}`); 
                const rb = document.getElementById('searchResults'); 
                rb.innerHTML=''; 
                
                // 2. Filter Owned Library (Client-side)
                const libraryMatches = ownedGames.filter(g => g.name.toLowerCase().includes(q));
                
                // Header for Library matches
                if (libraryMatches.length > 0) {
                    rb.innerHTML += `<div style="padding:5px 10px;font-size:10px;color:#666;text-transform:uppercase;font-weight:bold;">From Library</div>`;
                    libraryMatches.forEach(g => {
                        rb.innerHTML += `<div class="search-item" onclick="addGame(${g.id}, '${g.name.replace(/'/g, "\\'")}')"><span style="color:var(--status-green)">${g.name}</span> <span style="color:#666;">${g.id}</span></div>`;
                    });
                }

                // Header for Global matches
                if (res.length > 0) {
                    rb.innerHTML += `<div style="padding:5px 10px;font-size:10px;color:#666;text-transform:uppercase;font-weight:bold;border-top:1px solid #333;margin-top:5px;">Global Steam DB</div>`;
                    res.forEach(g => { 
                        // Avoid duplicates if already shown in library section
                        if (!libraryMatches.find(l => l.id === g.appid)) {
                            rb.innerHTML += `<div class="search-item" onclick="addGame(${g.appid}, '${g.name.replace(/'/g, "\\'")}')"><span>${g.name}</span><span style="color:#666;">${g.appid}</span></div>`; 
                        }
                    }); 
                }
                
                if(rb.innerHTML === '') rb.innerHTML = '<div style="padding:10px;color:#666;text-align:center;font-size:12px;">No results</div>';
                rb.style.display='block'; 
            }, 300); 
        });
        
        async function saveGames() { await apiCall('/api/games', 'POST', { username: document.getElementById('manageGameUsername').value, games: currentSelectedGames.map(g=>g.id), customStatus: document.getElementById('customStatus').value, personaState: document.getElementById('personaState').value }); closeModals(); fetchAccounts(); }

        setInterval(() => { if(authToken && activeTab === 'dash') fetchAccounts(); }, 3000);
        document.getElementById('panelPass').addEventListener("keypress", (e) => { if (e.key === "Enter") performLogin(); });
    </script>
</body>
</html>